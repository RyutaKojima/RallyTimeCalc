# Firestore データ自動削除（TTL）設定手順

60日間アクティビティがないデータを自動削除するために、FirebaseコンソールでTime-to-Live (TTL) ポリシーを設定する必要があります。

## 前提条件
- Firebaseプロジェクトの「オーナー」または「編集者」権限が必要です。
- [Firebaseコンソール](https://console.firebase.google.com/)にアクセスできる必要があります。

## 手順 1: Room（部屋）データのTTL設定

1.  **Firebaseコンソール**を開き、対象のプロジェクトを選択します。
2.  左側のメニューから **Firestore Database** をクリックします。
3.  **データ**タブをクリックしてコレクションを表示します。
4.  **TTL** (Time-to-Live) タブをクリックします（「Cloud Firestore」設定内の「ポリシー」タブにある場合もあります）。
5.  **ポリシーを作成**をクリックします。
6.  以下の情報を入力します:
    -   **コレクションパス**: `rooms`
    -   **タイムスタンプ フィールド**: `expireAt`
7.  **作成**をクリックします。

## 手順 2: Player（プレイヤー）データのTTL設定

1.  同じく **TTL** 設定画面に留まります。
2.  再度 **ポリシーを作成**をクリックします。
3.  以下の情報を入力します:
    -   **コレクショングループ**: `players`
        *(注意: 必ず「コレクショングループ」を選択してください。これにより、全ての部屋の `players` サブコレクションに適用されます)*
    -   **タイムスタンプ フィールド**: `expireAt`
4.  **作成**をクリックします。

## 確認方法

ポリシーを作成すると、Firestoreは `expireAt` タイムスタンプが過去の日時になっているドキュメントの削除を開始します。既存のデータに対しては反映されるまで最大24時間かかる場合がありますが、新しいデータには即座に適用されます。

## 仕組み

### 1. データの作成
新しい部屋やプレイヤーが作成されると、`expireAt` フィールドには **現在時刻から60日後** の日時が設定されます。

### 2. 有効期限の自動延長
ユーザーが部屋を表示（アクセス）すると、アプリは自動的に部屋およびその部屋に含まれる全プレイヤーの `expireAt` を **その時点から60日後** に一括更新します。
この更新処理は、前回の更新から約1日以上経過している場合にのみ実行され、不要な書き込みを抑制します。

### 3. 自動削除
60日間誰もアクセスしなかった部屋およびプレイヤーデータは、FirestoreのTTL機能によって自動的に削除されます。
部屋とプレイヤーはそれぞれ独立したTTLポリシーで管理されますが、アプリの「有効期限の自動延長」機能により両者の有効期限が常に同期されるため、実質的に同時に削除されます。
